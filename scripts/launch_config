#!/bin/bash
exec > >(tee -a /var/log/eb-cfn-init.log|logger -t [eb-cfn-init] -s 2>/dev/console) 2>&1
echo [`date -u +"%Y-%m-%dT%H:%M:%SZ"`] Started EB User Data
set -x


function sleep_delay 
{
  if (( $SLEEP_TIME < $SLEEP_TIME_MAX )); then 
    echo Sleeping $SLEEP_TIME
    sleep $SLEEP_TIME  
    SLEEP_TIME=$(($SLEEP_TIME * 2)) 
  else 
    echo Sleeping $SLEEP_TIME_MAX  
    sleep $SLEEP_TIME_MAX  
  fi
}

# Executing bootstrap script
SLEEP_TIME=10
SLEEP_TIME_MAX=3600
while true; do 
  curl https://s3-eu-west-2.amazonaws.com/elasticbeanstalk-env-resources-eu-west-2/stalks/eb_node_js_4.0.1.107.4/lib/UserDataScript.sh > /tmp/ebbootstrap.sh 
  RESULT=$?
  if [[ "$RESULT" -ne 0 ]]; then 
    sleep_delay 
  else
    
    #Install Code Deploy Agent
    sudo yum update -y
    sudo yum install -y ruby wget
    cd /home/ec2-user
    wget https://aws-codedeploy-eu-west-2.s3.amazonaws.com/latest/install
    sudo chmod +x ./install
    sudo ./install auto

    /bin/bash /tmp/ebbootstrap.sh     'https://s3-eu-west-2.amazonaws.com/elasticbeanstalk-env-resources-eu-west-2/stalks/eb_node_js_4.0.1.107.4/lib/aws-elasticbeanstalk-tools-1.19-1.noarch.rpm'    'https://s3-eu-west-2.amazonaws.com/elasticbeanstalk-env-resources-eu-west-2/stalks/eb_node_js_4.0.1.107.4/lib/awseb-ruby-2.2.4-x86_64-20160503_1008.tar.gz https://s3-eu-west-2.amazonaws.com/elasticbeanstalk-env-resources-eu-west-2/stalks/eb_node_js_4.0.1.107.4/lib/basehooks.tar.gz'    'https://s3-eu-west-2.amazonaws.com/elasticbeanstalk-env-resources-eu-west-2/stalks/eb_node_js_4.0.1.107.4/lib/beanstalk-core-2.10.gem https://s3-eu-west-2.amazonaws.com/elasticbeanstalk-env-resources-eu-west-2/stalks/eb_node_js_4.0.1.107.4/lib/beanstalk-core-healthd-1.1.gem https://s3-eu-west-2.amazonaws.com/elasticbeanstalk-env-resources-eu-west-2/stalks/eb_node_js_4.0.1.107.4/lib/executor-1.2.gem'    'https://cloudformation-waitcondition-eu-west-2.s3.eu-west-2.amazonaws.com/arn%3Aaws%3Acloudformation%3Aeu-west-2%3A624133288313%3Astack/awseb-e-zwqm5im8hg-stack/4b5e6680-88b7-11e7-994e-5081eddf4462/AWSEBInstanceLaunchWaitHandle?X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Date=20170824T103052Z&X-Amz-SignedHeaders=host&X-Amz-Expires=86399&X-Amz-Credential=AKIAIBEDYCZNGXXO5KMQ%2F20170824%2Feu-west-2%2Fs3%2Faws4_request&X-Amz-Signature=b1cfa36bfb7ae6340381682fb6232b828551705588a114c35083a293c0344c3b'    'arn:aws:cloudformation:eu-west-2:624133288313:stack/awseb-e-zwqm5im8hg-stack/4b5e6680-88b7-11e7-994e-5081eddf4462'    'eu-west-2'    '1d06de6daa13'    ''    ''    'nginx'    ''    && 
    exit 0  
  fi 
done


